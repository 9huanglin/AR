<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Sneaker Showcase - Hybrid Input</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Rajdhani', sans-serif;
            user-select: none;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* Loading Overlay */
        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0ff;
            z-index: 999;
            transition: opacity 0.5s;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid transparent;
            border-top: 3px solid #0ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Sci-Fi Info Panel */
        #info-panel {
            position: absolute;
            bottom: 50px;
            left: 50px;
            width: 350px;
            padding: 20px;
            background: rgba(0, 10, 20, 0.85);
            border-left: 4px solid #0ff;
            border-top: 1px solid rgba(0, 255, 255, 0.3);
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            color: #fff;
            transform: translateX(-150%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 10;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            clip-path: polygon(0 0, 100% 0, 100% 85%, 90% 100%, 0 100%);
        }

        #info-panel.active {
            transform: translateX(0);
        }

        .sci-fi-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #0ff;
            text-transform: uppercase;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
            letter-spacing: 2px;
        }

        .sci-fi-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 4px;
        }

        .label {
            color: #888;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .value {
            color: #fff;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .price {
            font-size: 1.8rem;
            color: #f0f;
            font-family: 'Orbitron', sans-serif;
            text-align: right;
            margin-top: 15px;
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }

        .deco-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #0ff, transparent);
            margin-top: 5px;
        }

        /* Debug / Status */
        #status {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #0f0;
            font-family: monospace;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            z-index: 10;
            border: 1px solid #0f0;
            text-align: right;
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 20px;" id="loader-text">INITIALIZING SYSTEM...</p>
        <p style="font-size: 12px; color: #666;">Attempting to load AI Hand Tracking...</p>
    </div>

    <div id="status">System: Checking...</div>

    <div id="canvas-container"></div>

    <div id="info-panel">
        <div class="sci-fi-title" id="p-name">LOADING...</div>
        <div class="sci-fi-row">
            <span class="label">Model Code</span>
            <span class="value" id="p-code">---</span>
        </div>
        <div class="sci-fi-row">
            <span class="label">Size Run</span>
            <span class="value" id="p-size">US 5-12</span>
        </div>
        <div class="sci-fi-row">
            <span class="label">Technology</span>
            <span class="value" id="p-tech">AIR / GORE-TEX</span>
        </div>
        <div class="price" id="p-price">$---.--</div>
        <div class="deco-line"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // --- Data ---
        const IMAGE_URLS = [
            "https://static.nike.com/a/images/q_auto:eco/t_product_v1/f_auto/dpr_1.0/h_594,c_limit/3989822d-5079-4b58-95cc-d884a12d5be8/%E3%83%8A%E3%82%A4%E3%82%AD-%E3%82%A8%E3%82%A2-%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B9-1-07-%E3%82%A6%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%BA%E3%82%B7%E3%83%A5%E3%83%BC%E3%82%BA-Csdlzsbt.png",
            "https://static.nike.com/a/images/q_auto:eco/t_product_v1/f_auto/dpr_1.0/h_594,c_limit/c5f06bdd-914b-4197-96bc-37d67b34c054/%E3%83%8A%E3%82%A4%E3%82%AD-%E3%82%A8%E3%82%A2-%E3%83%AA%E3%83%95%E3%83%88-%E3%82%A6%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%BA%E3%82%B7%E3%83%A5%E3%83%BC%E3%82%BA-ASOdehTz.png",
            "https://salomon.jp/cdn/shop/files/L47861800_0_GHO_XT-PATHWAYGTXVanill.png?v=1752547878&width=850",
            "https://www.skechers.com/dw/image/v2/BDCN_PRD/on/demandware.static/-/Library-Sites-SkechersSharedLibrary/default/dweddf4f88/images/2025-Images/Landing-Pages/boot-bf-space.jpg?sw=3000",
            "https://images.skechers.com/image;width=400%2Cformat=auto/177197_NVY_HERO_LG"
        ];

        const PRODUCT_DATA = [
            { name: "NIKE AF1 '07", code: "DD8959-100", price: "$110.00", tech: "Nike Air" },
            { name: "NIKE AIR RIFT", code: "DN1338-001", price: "$100.00", tech: "Split Toe" },
            { name: "SALOMON XT", code: "L47861800", price: "$160.00", tech: "Gore-Tex" },
            { name: "SKECHERS SPACE", code: "SKX-2025", price: "$85.00", tech: "Memory Foam" },
            { name: "SKECHERS HERO", code: "177197", price: "$75.00", tech: "Arch Fit" }
        ];

        // --- Variables ---
        let scene, camera, renderer, video, videoTexture;
        let handLandmarker;
        let lastVideoTime = -1;
        let inputMode = "MOUSE"; // 'MOUSE' or 'HAND'
        
        // Carousel
        const cards = [];
        const group = new THREE.Group();
        const CARD_WIDTH = 3.5;
        const GAP = 1.0;
        const TOTAL_WIDTH = (CARD_WIDTH + GAP) * IMAGE_URLS.length;
        
        // Logic
        let scrollOffset = 0;
        let baseSpeed = 0.02;
        let gestureSpeed = 0;
        let isZooming = false;
        let focusedIndex = -1;
        
        // Mouse specific
        let mouseX = 0;
        let targetScroll = 0;
        
        // UI
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const statusDiv = document.getElementById('status');
        const uiPanel = document.getElementById('info-panel');
        const uiName = document.getElementById('p-name');
        const uiCode = document.getElementById('p-code');
        const uiPrice = document.getElementById('p-price');
        const uiTech = document.getElementById('p-tech');

        async function init() {
            // 1. Three.js Setup
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.z = 10;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 2. Load Textures
            const textureLoader = new THREE.TextureLoader();
            textureLoader.crossOrigin = 'Anonymous';
            IMAGE_URLS.forEach((url, i) => {
                textureLoader.load(url, (texture) => {
                    texture.colorSpace = THREE.SRGBColorSpace;
                    const imgAspect = texture.image.width / texture.image.height;
                    const geometry = new THREE.PlaneGeometry(CARD_WIDTH, CARD_WIDTH / imgAspect);
                    const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true, side: THREE.DoubleSide });
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.userData = { id: i };
                    mesh.position.x = i * (CARD_WIDTH + GAP);
                    group.add(mesh);
                    cards.push(mesh);
                }, undefined, (err) => console.log('Texture error', err));
            });
            scene.add(group);

            // 3. Webcam Setup (Always try this)
            await setupWebcam();

            // 4. Try loading AI (with timeout)
            try {
                // Set a timeout promise
                const timeout = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 5000));
                // Race between setup and timeout
                await Promise.race([setupMediaPipe(), timeout]);
                
                inputMode = "HAND";
                statusDiv.innerHTML = "System: ONLINE<br>Mode: HAND GESTURE";
            } catch (err) {
                console.warn("AI Load Failed or Timed Out:", err);
                inputMode = "MOUSE";
                statusDiv.innerHTML = "System: ONLINE (AI Failed)<br>Mode: MOUSE / TOUCH";
                setupMouseControls();
            }

            // 5. Hide Loader
            loader.style.opacity = 0;
            setTimeout(() => loader.remove(), 500);

            // 6. Loop
            window.addEventListener('resize', onWindowResize);
            animate();
        }

        async function setupWebcam() {
            video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;
            video.muted = true;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720, facingMode: "user" } });
                video.srcObject = stream;
                await new Promise((r) => video.onloadedmetadata = r);
                video.play();
                
                videoTexture = new THREE.VideoTexture(video);
                videoTexture.colorSpace = THREE.SRGBColorSpace;
                const bgGeometry = new THREE.PlaneGeometry(25, 15);
                const bgMaterial = new THREE.MeshBasicMaterial({ map: videoTexture, depthWrite: false });
                const bgMesh = new THREE.Mesh(bgGeometry, bgMaterial);
                bgMesh.position.z = -5;
                const aspect = window.innerWidth / window.innerHeight;
                bgMesh.scale.set(aspect > 1 ? aspect : 1, aspect > 1 ? 1 : 1/aspect, 1);
                scene.add(bgMesh);
            } catch (e) {
                console.error("Webcam denied", e);
                statusDiv.innerText = "Error: Webcam Blocked";
            }
        }

        async function setupMediaPipe() {
            loaderText.innerText = "DOWNLOADING AI MODELS...";
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });
        }

        function setupMouseControls() {
            // Mouse Movement = Speed
            document.addEventListener('mousemove', (e) => {
                mouseX = (e.clientX / window.innerWidth) * 2 - 1; // -1 to 1
                gestureSpeed = -mouseX * 0.1; // Reverse for natural feel
            });
            // Click/Hold = Zoom
            document.addEventListener('mousedown', () => isZooming = true);
            document.addEventListener('mouseup', () => isZooming = false);
            // Touch support
            document.addEventListener('touchstart', () => isZooming = true);
            document.addEventListener('touchend', () => isZooming = false);
        }

        function detectGestures() {
            if (inputMode !== "HAND" || !handLandmarker || !video) return;

            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                const results = handLandmarker.detectForVideo(video, performance.now());
                if (results.landmarks && results.landmarks.length > 0) {
                    const lm = results.landmarks[0];
                    const thumb = lm[4];
                    const index = lm[8];
                    const dist = Math.sqrt(Math.pow(thumb.x - index.x, 2) + Math.pow(thumb.y - index.y, 2));

                    // Logic: Pinch = Zoom
                    isZooming = dist < 0.06;
                    
                    // Logic: Hand X = Speed
                    const handX = lm[9].x; 
                    gestureSpeed = (0.5 - handX) * 0.2; 
                    
                    statusDiv.innerHTML = `Mode: HAND<br>State: ${isZooming ? 'ZOOM' : 'SCROLL'}`;
                } else {
                    gestureSpeed = 0;
                    isZooming = false;
                    statusDiv.innerHTML = "Mode: HAND<br>State: SEARCHING...";
                }
            }
        }

        function updateCarousel() {
            if (!isZooming) {
                scrollOffset -= (baseSpeed + gestureSpeed);
                uiPanel.classList.remove('active');
            }

            let minDist = 9999;
            let closestMesh = null;

            cards.forEach((mesh, index) => {
                let virtualX = (index * (CARD_WIDTH + GAP) + scrollOffset) % TOTAL_WIDTH;
                if (virtualX > TOTAL_WIDTH / 2) virtualX -= TOTAL_WIDTH;
                if (virtualX < -TOTAL_WIDTH / 2) virtualX += TOTAL_WIDTH;

                if (!isZooming) {
                    mesh.position.x = THREE.MathUtils.lerp(mesh.position.x, virtualX, 0.1);
                    mesh.position.y = THREE.MathUtils.lerp(mesh.position.y, 0, 0.1);
                    mesh.position.z = THREE.MathUtils.lerp(mesh.position.z, 0, 0.1);
                    mesh.scale.setScalar(THREE.MathUtils.lerp(mesh.scale.x, 1, 0.1));
                    mesh.rotation.y = THREE.MathUtils.lerp(mesh.rotation.y, 0, 0.1);
                }

                const distToCenter = Math.abs(mesh.position.x);
                if (distToCenter < minDist) {
                    minDist = distToCenter;
                    closestMesh = mesh;
                    focusedIndex = mesh.userData.id;
                }
            });

            if (isZooming && closestMesh) {
                closestMesh.position.x = THREE.MathUtils.lerp(closestMesh.position.x, 0, 0.1);
                closestMesh.position.y = THREE.MathUtils.lerp(closestMesh.position.y, 0.5, 0.1);
                closestMesh.position.z = THREE.MathUtils.lerp(closestMesh.position.z, 5, 0.1);
                closestMesh.scale.setScalar(THREE.MathUtils.lerp(closestMesh.scale.x, 1.8, 0.1));
                closestMesh.rotation.y += 0.01;

                updateUI(focusedIndex);
                uiPanel.classList.add('active');
                
                cards.forEach(m => {
                    if (m !== closestMesh) m.position.z = -2;
                });
            }
        }

        function updateUI(index) {
            if(!PRODUCT_DATA[index]) return;
            const data = PRODUCT_DATA[index];
            uiName.innerText = data.name;
            uiCode.innerText = data.code;
            uiPrice.innerText = data.price;
            uiTech.innerText = data.tech;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            detectGestures();
            updateCarousel();
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>

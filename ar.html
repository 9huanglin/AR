<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Sneaker - Mobile Optimized</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Rajdhani', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #canvas-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }

        /* --- 启动页 (解决手机自动播放限制) --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.5s;
        }
        .start-btn {
            padding: 15px 40px; border: 2px solid #0ff; background: rgba(0,255,255,0.1);
            color: #0ff; font-family: 'Orbitron'; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 0 20px rgba(0,255,255,0.3); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 10px rgba(0,255,255,0.2); } 50% { box-shadow: 0 0 25px rgba(0,255,255,0.6); } 100% { box-shadow: 0 0 10px rgba(0,255,255,0.2); } }

        /* --- 加载层 --- */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; /* 默认隐藏，点击后显示 */
            flex-direction: column; justify-content: center; align-items: center;
            color: #0ff; z-index: 1000;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid #0ff;
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- 顶部状态栏 --- */
        #status-bar {
            position: absolute; top: 10px; right: 10px; left: 10px;
            display: flex; justify-content: space-between;
            font-family: monospace; font-size: 12px;
            color: rgba(0, 255, 255, 0.8); z-index: 10; pointer-events: none;
        }

        /* --- 响应式产品信息面板 --- */
        #info-panel {
            position: absolute; 
            z-index: 10;
            background: rgba(5, 15, 25, 0.9);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-left: 4px solid #0ff;
            backdrop-filter: blur(10px);
            color: #fff;
            transform: translateY(150%);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            
            /* 手机端样式：底部卡片 */
            bottom: 20px; left: 5%; width: 90%; box-sizing: border-box; padding: 20px;
            border-radius: 10px 0 10px 0;
        }

        /* 大屏幕适配 */
        @media (min-width: 768px) {
            #info-panel {
                bottom: 50px; left: 50px; width: 350px;
                transform: translateX(-150%);
                clip-path: polygon(0 0, 100% 0, 100% 85%, 90% 100%, 0 100%);
                border-radius: 0;
            }
            #info-panel.active { transform: translateX(0); }
        }

        /* 手机端激活状态 */
        #info-panel.active { transform: translateY(0); }

        .p-title { font-family: 'Orbitron'; font-size: 1.4rem; color: #0ff; margin-bottom: 10px; }
        .p-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .p-price { font-family: 'Orbitron'; font-size: 1.8rem; color: #f0f; text-align: right; margin-top: 10px; }
    </style>
</head>
<body>

    <!-- 1. 启动页 (必须有点击动作才能在手机播放视频) -->
    <div id="start-screen">
        <h1 style="color:white; font-family:'Orbitron'; margin-bottom:30px;">AR SHOWCASE</h1>
        <div class="start-btn" onclick="startApp()">TAP TO START</div>
        <p style="color:#666; font-size:12px; margin-top:20px;">Use in bright light • Show your hand</p>
    </div>

    <!-- 2. 加载页 -->
    <div id="loader">
        <div class="spinner"></div>
        <div id="loader-text">CONNECTING...</div>
    </div>

    <!-- 3. UI 界面 -->
    <div id="status-bar">
        <span>CAM: ACTIVE</span>
        <span id="gesture-state">WAITING...</span>
    </div>

    <div id="canvas-container"></div>

    <div id="info-panel">
        <div class="p-title" id="p-name">LOADING</div>
        <div class="p-row"><span>CODE</span><span id="p-code">---</span></div>
        <div class="p-row"><span>TECH</span><span id="p-tech">---</span></div>
        <div class="p-price" id="p-price">$---</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // --- 配置 ---
        // 强制使用 Lite 模型 (体积更小，速度更快)
        const MODEL_URL = "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task";
        
        const IMAGE_URLS = [
            "https://static.nike.com/a/images/q_auto:eco/t_product_v1/f_auto/dpr_1.0/h_594,c_limit/3989822d-5079-4b58-95cc-d884a12d5be8/%E3%83%8A%E3%82%A4%E3%82%AD-%E3%82%A8%E3%82%A2-%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B9-1-07-%E3%82%A6%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%BA%E3%82%B7%E3%83%A5%E3%83%BC%E3%82%BA-Csdlzsbt.png",
            "https://static.nike.com/a/images/q_auto:eco/t_product_v1/f_auto/dpr_1.0/h_594,c_limit/c5f06bdd-914b-4197-96bc-37d67b34c054/%E3%83%8A%E3%82%A4%E3%82%AD-%E3%82%A8%E3%82%A2-%E3%83%AA%E3%83%95%E3%83%88-%E3%82%A6%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%BA%E3%82%B7%E3%83%A5%E3%83%BC%E3%82%BA-ASOdehTz.png",
            "https://salomon.jp/cdn/shop/files/L47861800_0_GHO_XT-PATHWAYGTXVanill.png?v=1752547878&width=850",
            "https://www.skechers.com/dw/image/v2/BDCN_PRD/on/demandware.static/-/Library-Sites-SkechersSharedLibrary/default/dweddf4f88/images/2025-Images/Landing-Pages/boot-bf-space.jpg?sw=3000",
            "https://images.skechers.com/image;width=400%2Cformat=auto/177197_NVY_HERO_LG"
        ];
        const PRODUCT_DATA = [
            { name: "NIKE AF1", code: "DD8959", price: "$110", tech: "AIR" },
            { name: "NIKE RIFT", code: "DN1338", price: "$100", tech: "SPLIT" },
            { name: "SALOMON XT", code: "L4786", price: "$160", tech: "GTX" },
            { name: "SKECHERS", code: "SKX25", price: "$85", tech: "FOAM" },
            { name: "SKECHERS", code: "177197", price: "$75", tech: "ARCH" }
        ];

        let scene, camera, renderer, video, handLandmarker;
        let lastTime = -1;
        
        // 交互变量
        const group = new THREE.Group();
        const cards = [];
        const CARD_W = 3.5;
        const GAP = 1.0;
        let scrollOffset = 0;
        let speed = 0.01;
        let gestureSpeed = 0;
        let isZooming = false;
        
        // DOM
        const statusEl = document.getElementById('gesture-state');
        const uiPanel = document.getElementById('info-panel');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');

        // 暴露给全局以便点击调用
        window.startApp = async () => {
            document.getElementById('start-screen').style.display = 'none';
            loader.style.display = 'flex';
            
            try {
                await init();
                loader.style.display = 'none';
            } catch (e) {
                console.error(e);
                loaderText.innerText = "FAILED: " + e.message;
                loaderText.style.color = 'red';
            }
        }

        async function init() {
            // 1. 初始化 3D 场景
            scene = new THREE.Scene();
            
            // 摄像机适配：手机端(竖屏)需要把相机拉远，否则物体太大
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(50, aspect, 0.1, 100);
            if (aspect < 1) {
                // 竖屏模式 (手机)
                camera.position.z = 18; // 拉远
            } else {
                // 横屏模式 (电脑)
                camera.position.z = 10;
            }

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // 限制像素比以提升手机性能
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 2. 加载图片
            const texLoader = new THREE.TextureLoader();
            texLoader.crossOrigin = 'anonymous';
            
            IMAGE_URLS.forEach((url, i) => {
                texLoader.load(url, tex => {
                    tex.colorSpace = THREE.SRGBColorSpace;
                    const imgAspect = tex.image.width / tex.image.height;
                    const geo = new THREE.PlaneGeometry(CARD_W, CARD_W / imgAspect);
                    const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide });
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.userData = { id: i };
                    mesh.position.x = i * (CARD_W + GAP);
                    group.add(mesh);
                    cards.push(mesh);
                });
            });
            scene.add(group);

            // 3. 摄像头 (关键：手机必须请求 correct facingMode)
            video = document.createElement('video');
            video.playsInline = true; // iOS 必须
            video.muted = true;
            video.autoplay = true;

            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'user', // 前置摄像头
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            video.srcObject = stream;
            await new Promise(r => video.onloadedmetadata = r);
            video.play();

            // 视频背景适配
            const vidTex = new THREE.VideoTexture(video);
            vidTex.colorSpace = THREE.SRGBColorSpace;
            const bgGeo = new THREE.PlaneGeometry(20, 20 * (1/aspect)); // 保证覆盖
            const bgMat = new THREE.MeshBasicMaterial({ map: vidTex, depthWrite: false });
            const bgMesh = new THREE.Mesh(bgGeo, bgMat);
            bgMesh.position.z = -10;
            
            // 简单的 Cover 算法
            const vidAspect = video.videoWidth / video.videoHeight;
            const screenAspect = window.innerWidth / window.innerHeight;
            if (screenAspect > vidAspect) {
                bgMesh.scale.set(screenAspect / vidAspect, 1, 1);
            } else {
                bgMesh.scale.set(1, vidAspect / screenAspect, 1);
            }
            scene.add(bgMesh);

            // 4. 加载 AI (使用轻量化设置)
            loaderText.innerText = "LOADING AI (LITE)...";
            
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
            );
            
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: MODEL_URL, 
                    delegate: "CPU" // 手机浏览器对 GPU 推理支持不稳定，CPU 最安全
                },
                runningMode: "VIDEO",
                numHands: 1,
                minHandDetectionConfidence: 0.5
            });

            animate();
            
            // 监听屏幕旋转
            window.addEventListener('resize', () => {
                const newAspect = window.innerWidth / window.innerHeight;
                camera.aspect = newAspect;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                // 重新调整相机距离
                camera.position.z = newAspect < 1 ? 18 : 10;
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            // AI 检测
            if (handLandmarker && video.readyState >= 2) {
                if (video.currentTime !== lastTime) {
                    lastTime = video.currentTime;
                    const res = handLandmarker.detectForVideo(video, performance.now());
                    
                    if (res.landmarks.length > 0) {
                        const lm = res.landmarks[0];
                        
                        // 1. 捏合检测
                        const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                        if (dist < 0.06) {
                            isZooming = true;
                            statusEl.innerText = "ZOOMING";
                            statusEl.style.color = "#f0f";
                        } else {
                            isZooming = false;
                            statusEl.innerText = "SCROLLING";
                            statusEl.style.color = "#0ff";
                        }

                        // 2. 速度控制 (注意：手机前置摄像头通常是镜像的)
                        const handX = lm[9].x; 
                        gestureSpeed = (0.5 - handX) * 0.4; // 增加手机端的灵敏度
                        
                    } else {
                        gestureSpeed = 0;
                        isZooming = false;
                        statusEl.innerText = "NO HAND";
                        statusEl.style.color = "#888";
                    }
                }
            }

            // 场景更新
            if (!isZooming) {
                scrollOffset -= (speed + gestureSpeed);
                uiPanel.classList.remove('active');
            }

            let minDist = 9999, centerMesh = null;
            const totalW = cards.length * (CARD_W + GAP);

            cards.forEach((mesh, idx) => {
                let vx = (idx * (CARD_W + GAP) + scrollOffset) % totalW;
                if(vx > totalW/2) vx -= totalW;
                if(vx < -totalW/2) vx += totalW;

                if (!isZooming) {
                    mesh.position.set(vx, 0, 0);
                    mesh.scale.setScalar(1);
                    mesh.rotation.y = 0;
                    mesh.material.opacity = 1;
                }

                if(Math.abs(mesh.position.x) < minDist) {
                    minDist = Math.abs(mesh.position.x);
                    centerMesh = mesh;
                }
            });

            if (isZooming && centerMesh) {
                // 手机端放大参数调整
                const isPortrait = window.innerWidth < window.innerHeight;
                const zoomZ = isPortrait ? 10 : 4; // 手机上不要飞得太近，否则爆屏
                const zoomY = isPortrait ? 1.5 : 0.5; // 手机上抬高一点给文字留位置

                centerMesh.position.lerp(new THREE.Vector3(0, zoomY, zoomZ), 0.1);
                centerMesh.scale.setScalar(THREE.MathUtils.lerp(centerMesh.scale.x, 1.8, 0.1));
                centerMesh.rotation.y += 0.01;

                // 模糊背景卡片
                cards.forEach(m => {
                    if(m !== centerMesh) {
                        m.position.z = THREE.MathUtils.lerp(m.position.z, -10, 0.1);
                        m.material.opacity = 0.2;
                    }
                });

                // 更新 UI
                const data = PRODUCT_DATA[centerMesh.userData.id];
                if (data) {
                    document.getElementById('p-name').innerText = data.name;
                    document.getElementById('p-code').innerText = data.code;
                    document.getElementById('p-tech').innerText = data.tech;
                    document.getElementById('p-price').innerText = data.price;
                    uiPanel.classList.add('active');
                }
            }
            
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
